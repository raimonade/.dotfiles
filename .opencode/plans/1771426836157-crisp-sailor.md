# Plan: Sync upstream dmmulroy/.dotfiles improvements

## Summary

Cherry-pick high-value changes from upstream into our local dotfiles, then install/restow so they're live in both OpenCode and Claude Code (AGENTS.md).

---

## What upstream has that we don't

### 1. `feedback-loop` skill (HIGH VALUE)
Full self-validation framework for AI agents. Three loop types (debugging, UI/visual, data pipeline), tmux watcher integration, Sense→Hypothesize→Change→Measure→Decide cycle, flaky repro handling, escalation triggers.
- `skill/feedback-loop/SKILL.md`
- `skill/feedback-loop/references/loop-recipes.md`
- `skill/feedback-loop/references/examples.md`

### 2. `task-loop` (HIGH VALUE)
Autonomous PRD implementation loop — runs `/complete-next-task` in a bash loop up to 25 iterations until `<tasks>COMPLETE</tasks>` is detected.
- `home/.local/bin/task-loop` (bash script)
- `home/.config/fish/functions/task-loop.fish` (thin wrapper)
- `home/.config/opencode/command/complete-next-task.md` (the command it calls)

### 3. `code-review` command (HIGH VALUE)
Parallel review pattern: 3× `@code-reviewer` subagents + Oracle verification. Already have `code-reviewer.md` agent, just missing the command.
- `home/.config/opencode/command/code-review.md`

### 4. Hierarchical `AGENTS.md` files (MEDIUM VALUE)
Upstream has per-subsystem AGENTS.md files with structured machine-readable context:
- `home/.config/nvim/AGENTS.md` — neovim config map for AI agents
- `home/.config/fish/AGENTS.md` — fish config map for AI agents
These complement the root `AGENTS.md` we already have.

### 5. `opencode.fish` conf.d fragment (MEDIUM VALUE)
Sets experimental feature flags:
- `OPENCODE_EXPERIMENTAL_LSP_TOOL=1`
- `OPENCODE_EXPERIMENTAL_PLAN_MODE=1`  
- `OPENCODE_ENABLE_EXA=1`
We currently set `OPENCODE_EXPERIMENTAL_PLAN_MODE=1` inline in `opencode.json` but not the other two flags.

### 6. `librarian.md` agent improvements (LOW-MEDIUM)
Upstream's librarian has richer tool arsenal docs (opensrc/grep_app/context7/websearch/codesearch) and fluent GitHub linking instructions. Ours is similar but less documented.

### 7. `install-fe-skills` fish function (LOW VALUE — skip)
Installs remote vercel/anthropics skills. These are external and Cloudflare-specific. Skip.

### 8. Nvim `AGENTS.md` mentions `ocamllsp`, `rust_analyzer`, `biome`, `eslint` LSP servers and `TwoSlash` plugin that we don't have. (OUT OF SCOPE — nvim is separate concern)

---

## What we already have (no change needed)

- `oracle.md` agent — ours is equivalent (we already have opensrc/context7/grep_app tools added)
- `vcs-detect` skill — already present
- `spec-planner` skill — already present, actually ahead of upstream
- `overseer` skill/command — already present
- `preemptive-compaction` plugin — already present
- Root `AGENTS.md` — already present and up to date
- `opencode.json` MCP servers — we have all the same ones (context7, grep_app, opensrc, overseer, excalidraw)

---

## Implementation Plan

### Step 1: Add `feedback-loop` skill
Create `home/.config/opencode/skill/feedback-loop/` with:
- `SKILL.md` — copy from upstream verbatim
- `references/loop-recipes.md` — copy from upstream verbatim
- `references/examples.md` — copy from upstream verbatim

### Step 2: Add `task-loop`
Create:
- `home/.local/bin/task-loop` — bash script (copy from upstream verbatim, make executable)
- `home/.config/fish/functions/task-loop.fish` — thin wrapper (copy from upstream verbatim)
- `home/.config/opencode/command/complete-next-task.md` — command definition (copy from upstream verbatim)

### Step 3: Add `code-review` command
Create `home/.config/opencode/command/code-review.md` — copy from upstream verbatim.

### Step 4: Add subsystem `AGENTS.md` files
Adapt upstream's nvim and fish AGENTS.md to match our local structure (our paths use `rk/` not `dmmulroy/`):
- `home/.config/nvim/AGENTS.md` — upstream version adapted: change `dmmulroy` → `rk` in paths
- `home/.config/fish/AGENTS.md` — copy from upstream verbatim (paths are same)

### Step 5: Add `opencode.fish` conf.d fragment
Create `home/.config/fish/conf.d/opencode.fish` with:
```fish
set -gx OPENCODE_EXPERIMENTAL_LSP_TOOL 1
set -gx OPENCODE_EXPERIMENTAL_PLAN_MODE 1
set -gx OPENCODE_ENABLE_EXA 1
```

### Step 6: Update root `AGENTS.md` 
Add references to new subsystem AGENTS.md files in the STRUCTURE section so agents know they exist.

### Step 7: Stow + install
```bash
dot stow   # resymlink home/.config/* -> ~/.config/*
# task-loop needs to be in PATH — ~/.local/bin must be on PATH (it is via paths.fish)
chmod +x ~/.config/../.local/bin/task-loop  # actually stowed to ~/.local/bin/task-loop
```

Note: `home/.local/` is a new stow target — need to verify `dot stow` handles it or if we need `stow -d home -t ~ .local`.

### Step 8: Make available for Claude Code
Claude Code reads `AGENTS.md` files. The new subsystem AGENTS.md files will be auto-discovered by Claude Code when it's run in those directories. The root `AGENTS.md` update covers global awareness.

No changes needed to Claude Code config specifically — it reads AGENTS.md hierarchically.

---

## Files to create/modify

| Action | File |
|--------|------|
| CREATE | `home/.config/opencode/skill/feedback-loop/SKILL.md` |
| CREATE | `home/.config/opencode/skill/feedback-loop/references/loop-recipes.md` |
| CREATE | `home/.config/opencode/skill/feedback-loop/references/examples.md` |
| CREATE | `home/.local/bin/task-loop` |
| CREATE | `home/.config/fish/functions/task-loop.fish` |
| CREATE | `home/.config/opencode/command/complete-next-task.md` |
| CREATE | `home/.config/opencode/command/code-review.md` |
| CREATE | `home/.config/nvim/AGENTS.md` |
| CREATE | `home/.config/fish/AGENTS.md` |
| CREATE | `home/.config/fish/conf.d/opencode.fish` |
| MODIFY | `AGENTS.md` (root) — add fish/nvim AGENTS.md refs |

---

## Verification

```bash
# After stow:
ls -la ~/.config/opencode/skill/feedback-loop/
ls -la ~/.config/opencode/command/complete-next-task.md
ls -la ~/.config/opencode/command/code-review.md
ls -la ~/.local/bin/task-loop
ls -la ~/.config/fish/conf.d/opencode.fish
ls -la ~/.config/nvim/AGENTS.md
ls -la ~/.config/fish/AGENTS.md

# task-loop is executable:
test -x ~/.local/bin/task-loop && echo "ok"

# env vars loaded in new fish shell:
fish -c 'echo $OPENCODE_EXPERIMENTAL_LSP_TOOL'  # should print 1
```

---

## Unresolved questions

1. Should we adapt `complete-next-task.md` to reference our PRD state dir convention, or keep upstream's verbatim?
2. `opencode.fish` — we already have `fish_add_path /Users/raimondskorzenevskis/.opencode/bin` in `config.fish` directly; should that move to `conf.d/paths.fish` for consistency? (separate concern, can defer)

**Resolved:**
- `dot stow` uses `stow -R -d DOTFILES_DIR -t HOME home` — covers all of `home/` including `home/.local/bin/` ✓
- `~/.local/bin` is already on PATH via `conf.d/paths.fish` ✓
